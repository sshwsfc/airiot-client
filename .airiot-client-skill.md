# @airiot/client 使用指南

这是一个全面的技能指南，帮助你正确、准确地使用 @airiot/client 库的所有功能和接口。

## 目录

1. [库概述](#库概述)
2. [安装和初始化](#安装和初始化)
3. [全局配置](#全局配置)
4. [API 模块](#api-模块)
5. [认证模块](#认证模块)
6. [表单模块](#表单模块)
7. [模型模块](#模型模块)
8. [工具函数](#工具函数)
9. [类型定义](#类型定义)
10. [常见使用模式](#常见使用模式)
11. [最佳实践](#最佳实践)

---

## 库概述

@airiot/client 是一个 TypeScript 客户端库，为 React 应用提供完整的 API、认证、表单处理和模型管理功能。

### 核心特性

- **API 客户端** - 简化的 HTTP 请求，支持查询、过滤、分页
- **身份认证** - 完整的登录/登出流程，支持记住我功能
- **表单处理** - 基于 JSON Schema 的表单构建和验证
- **模型管理** - 集成的状态管理和数据操作
- **内置模型** - 46 个预置的 Airiot 系统模型

### 技术栈

- React 18+
- TypeScript
- Jotai (状态管理)
- Axios (HTTP 请求)
- React Final Form (表单管理)
- AJV (JSON Schema 验证)

---

## 安装和初始化

### 安装依赖

```bash
# 安装 @airiot/client
npm install @airiot/client

# 安装 peer dependencies
npm install react react-dom react-router jotai dayjs axios lodash
npm install final-form ajv react-final-form react-final-form-arrays
npm install crypto-js localforage
```

### 初始化全局配置

在应用入口文件（如 `main.tsx` 或 `index.tsx`）中初始化：

```typescript
import { setConfig } from '@airiot/client'

setConfig({
  language: 'zh-CN',
  module: 'admin',
  user: { token: 'your-token' },
  settings: {
    safeRequest: true
  }
})
```

---

## 全局配置

### Config 接口

```typescript
interface Config {
  language?: string        // 语言设置 (zh-CN, en-US)
  module?: string          // 当前模块 (admin, reception)
  theme?: string           // 主题
  user?: User             // 用户信息
  settings?: {
    safeRequest?: boolean  // 安全请求
    [key: string]: any
  }
  [key: string]: any      // 其他自定义配置
}
```

### 配置方法

#### `setConfig(config: any)`

设置全局配置。

```typescript
import { setConfig } from '@airiot/client'

setConfig({
  language: 'zh-CN',
  module: 'admin'
})
```

#### `getConfig(): any`

获取当前全局配置。

```typescript
import { getConfig } from '@airiot/client'

const config = getConfig()
console.log(config.user)
console.log(config.language)
```

---

## API 模块

API 模块提供简化的 HTTP 客户端，用于与后端 REST API 交互。

### 创建 API 实例

#### `createAPI(options: APIOptions, context?: AppContext): APIInstance`

```typescript
import { createAPI } from '@airiot/client'

const api = createAPI({
  name: 'user',              // API 名称
  resource: 'core/user',      // 资源路径
  proxyKey: '',               // 代理键
  headers: {},                // 自定义请求头
  idProp: 'id',             // ID 属性名
  convertItem: (item) => {    // 数据转换函数
    return {
      ...item,
      fullName: `${item.firstName} ${item.lastName}`
    }
  },
  queryParams: {},            // 默认查询参数
  projectAll: false,          // 是否返回所有字段
  projectFields: [],          // 要返回的字段列表
  customQuery: async () => {}  // 自定义查询函数
  apiMessage: true,          // 是否显示 API 消息
  properties: {}              // 属性定义
})
```

#### APIOptions 类型

```typescript
interface APIOptions {
  name?: string
  resource?: string
  proxyKey?: string
  headers?: Record<string, string>
  idProp?: string | string[]
  convertItem?: (item: any) => any
  queryParams?: Record<string, any>
  projectAll?: boolean
  projectFields?: string[]
  customQuery?: (api: any, filter: any, wheres: any, convertItem: any) => Promise<any>
  apiMessage?: boolean
  properties?: Record<string, SchemaProperty>
}
```

### API 方法

#### `fetch(uri: string, options?: FetchOptions): Promise<APIResponse>`

通用 HTTP 请求方法。

```typescript
const response = await api.fetch('/detail', {
  method: 'GET',
  headers: { 'X-Custom-Header': 'value' }
})

console.log(response.json)    // 响应数据
console.log(response.headers) // 响应头
```

#### `query(filter?: any, wheres?: any, withCount?: boolean, ...params: any[]): Promise<{ items: any[]; total: number }>`

查询数据列表。

```typescript
// 基础查询
const { items, total } = await api.query()

// 带分页和排序
const { items, total } = await api.query({
  skip: 0,
  limit: 20,
  order: { createdAt: 'DESC' }
})

// 带过滤条件
const { items, total } = await api.query(
  { limit: 10 },
  { status: { $eq: 'active' } }
)

// 不返回总数
const { items } = await api.query({}, {}, false)
```

**QueryOptions 类型：**

```typescript
interface QueryOptions {
  order?: Record<string, 'ASC' | 'DESC'>
  skip?: number
  limit?: number
  groupBy?: string
  fields?: string[]
}
```

#### `get(id?: string, option?: FetchOptions): Promise<any>`

获取单条数据。

```typescript
// 获取指定 ID 的数据
const user = await api.get('user123')

// 带选项获取
const user = await api.get('user123', {
  headers: { 'X-Custom-Header': 'value' }
})
```

#### `delete(id?: string): Promise<any>`

删除数据。

```typescript
await api.delete('user123')
```

#### `save(data?: any, partial?: boolean): Promise<any>`

保存数据（新增或更新）。

```typescript
// 新增数据
const newUser = await api.save({
  username: 'john',
  email: 'john@example.com'
})

// 更新数据（有 ID）
const updatedUser = await api.save({
  id: 'user123',
  username: 'john_doe'
})

// 部分更新（PATCH）
const updatedUser = await api.save({
  id: 'user123',
  email: 'newemail@example.com'
}, true)
```

#### `count(filter?: any): Promise<number>`

获取数据总数。

```typescript
const total = await api.count({ status: 'active' })
```

### 查询条件操作符

支持丰富的查询条件操作符：

```typescript
// 等于
await api.query({}, { status: { $eq: 'active' } })

// 不等于
await api.query({}, { status: { $ne: 'inactive' } })

// 大于/大于等于/小于/小于等于
await api.query({}, { age: { $gte: 18 } })
await api.query({}, { age: { $lte: 65 } })

// 包含（数组）
await api.query({}, { tags: { $in: ['a', 'b', 'c'] } })

// 不包含（数组）
await api.query({}, { tags: { $nin: ['x', 'y', 'z'] } })

// 正则匹配
await api.query({}, { username: { $regex: '^john' } })

// 逻辑与
await api.query({}, {
  $and: [
    { status: { $eq: 'active' } },
    { age: { $gte: 18 } }
  ]
})

// 逻辑或
await api.query({}, {
  $or: [
    { status: 'active' },
    { status: 'pending' }
  ]
})

// 逻辑非
await api.query({}, {
  $not: { status: 'deleted' }
})
```

### API 上下文

#### `setContext(user: any)`

设置 API 上下文（用户信息）。

```typescript
import { setContext } from '@airiot/client'

setContext({
  token: 'your-token',
  id: 'user123',
  username: 'admin'
})
```

#### `getContext(): any`

获取当前 API 上下文。

```typescript
import { getContext } from '@airiot/client'

const context = getContext()
console.log(context.user)
```

### 错误处理

```typescript
try {
  const data = await api.get('item123')
} catch (error) {
  if (error.status === 401) {
    // 未授权
    navigate('/login')
  } else if (error.status === 403) {
    // 无权限
    message.error('您没有权限执行此操作')
  } else if (error.status === 404) {
    // 资源不存在
    message.error('数据不存在')
  } else if (error.status === 500) {
    // 服务器错误
    message.error('服务器错误，请稍后重试')
  } else {
    console.error('API Error:', error)
    message.error(error.json?._error || '操作失败')
  }
}
```

---

## 认证模块

认证模块提供完整的身份认证功能，包括登录、登出、用户注册和用户状态管理。

### useUser()

获取和设置用户信息。

```typescript
import { useUser } from '@airiot/client'

function UserProfile() {
  const { user, setUser, storageKey } = useUser()

  return (
    <div>
      {user ? <p>Welcome, {user.username}</p> : <p>Please login</p>}
    </div>
  )
}
```

**返回值：**
- `user` - 当前用户信息
- `setUser` - 设置用户信息的函数
- `storageKey` - 存储键名（默认为 'user'）

### useLogin()

提供登录功能。

```typescript
import { useLogin } from '@airiot/client'

function LoginForm() {
  const { showCode, onLogin } = useLogin()

  const handleSubmit = async (values) => {
    try {
      const result = await onLogin({
        username: values.username,
        password: values.password,
        verifyCode: values.verifyCode,
        remenber: values.remember
      })
      // 登录成功，result 包含 needChangePwd, password, id, username
      console.log('Login success:', result)
    } catch (error) {
      // 登录失败，error 包含表单验证错误
      console.error('Login failed:', error)
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input name="username" type="text" placeholder="用户名" />
      <input name="password" type="password" placeholder="密码" />
      {showCode && <input name="verifyCode" type="text" placeholder="验证码" />}
      <label>
        <input name="remember" type="checkbox" />
        记住我
      </label>
      <button type="submit">登录</button>
    </form>
  )
}
```

**返回值：**
- `showCode` - 是否显示验证码输入框（Boolean）
- `onLogin` - 登录函数

**onLogin 参数：**
- `username` - 用户名（必填）
- `password` - 密码（必填）
- `verifyCode` - 验证码（可选）
- `remenber` - 是否记住登录状态（布尔值）

**onLogin 返回值（Promise）：**
- `needChangePwd` - 是否需要修改密码
- `password` - 密码
- `id` - 用户 ID
- `username` - 用户名

### useLogout()

提供登出功能。

```typescript
import { useLogout } from '@airiot/client'

function LogoutButton() {
  const { onLogout } = useLogout()

  const handleLogout = () => {
    onLogout()
  }

  return <button onClick={handleLogout}>登出</button>
}
```

**返回值：**
- `onLogout` - 登出函数（无参数，无返回值）

### useUserReg()

提供用户注册功能。

```typescript
import { useUserReg } from '@airiot/client'

function RegisterForm() {
  const { onUserReg } = useUserReg()

  const handleSubmit = async (values) => {
    try {
      await onUserReg(values)
      // 注册成功，自动跳转到登录页面
      console.log('Registration success')
    } catch (error) {
      console.error('Registration failed:', error)
    }
  }

  return <form onSubmit={handleSubmit}>...</form>
}
```

**返回值：**
- `onUserReg` - 注册函数

**onUserReg 参数：**
注册表单的所有字段值，通常包括：
- `username` - 用户名
- `password` - 密码
- `email` - 邮箱
- 其他自定义字段

### User 类型

```typescript
interface User {
  token?: string           // 认证令牌
  id?: string             // 用户 ID
  username?: string       // 用户名
  email?: string          // 邮箱
  isAdmin?: boolean       // 是否管理员
  permissions?: string[]  // 权限列表
  node?: any              // 节点信息
  nodeInUser?: any        // 用户节点信息
  // 其他自定义字段
}
```

### 认证流程

#### 登录流程

1. 用户提交登录表单
2. 调用 `onLogin` 函数
3. 密码使用 SHA1 加密
4. 发送登录请求到 `core/auth/login`
5. 成功后：
   - 用户信息存储到 localStorage 或 sessionStorage
   - 更新全局用户状态
   - 跳转到目标页面（或首页）
6. 失败后：
   - 显示错误信息
   - 如果需要验证码，显示验证码输入框

#### 登出流程

1. 调用 `onLogout` 函数
2. 发送登出请求到 `core/auth/logout`
3. 清除存储的用户信息（localStorage 和 sessionStorage）
4. 更新全局用户状态为 null
5. 跳转到登出页面

#### 注册流程

1. 用户提交注册表单
2. 调用 `onUserReg` 函数
3. 密码使用 SHA1 加密
4. 发送注册请求到 `core/register/normal`
5. 成功后显示成功消息，跳转到登录页面
6. 失败后显示错误信息

---

## 表单模块

表单模块基于 JSON Schema 提供强大的表单构建和验证功能。

### 组件

#### SchemaForm

基于 JSON Schema 的表单组件。

```typescript
import { SchemaForm } from '@airiot/client'

const userSchema = {
  type: 'object',
  properties: {
    username: {
      type: 'string',
      title: '用户名',
      minLength: 3
    },
    email: {
      type: 'string',
      format: 'email',
      title: '邮箱'
    }
  },
  required: ['username', 'email']
}

function UserForm() {
  const handleSubmit = (values) => {
    console.log('Form values:', values)
  }

  return (
    <SchemaForm
      schema={userSchema}
      onSubmit={handleSubmit}
    />
  )
}
```

**Props：**
- `schema` - JSON Schema 对象（必填）
- `onSubmit` - 提交回调函数
- `validate` - 自定义验证函数
- `initialValues` - 初始值

#### Form

通用表单组件。

```typescript
import { Form } from '@airiot/client'

function MyForm() {
  return (
    <Form onSubmit={handleSubmit}>
      <input name="username" />
      <input name="email" type="email" />
      <button type="submit">提交</button>
    </Form>
  )
}
```

#### BaseForm

基础表单组件，提供更多自定义选项。

```typescript
import { BaseForm } from '@airiot/client'

function CustomForm() {
  return (
    <BaseForm
      schema={schema}
      onSubmit={handleSubmit}
      validate={validate}
      effect={effect}
      {...otherProps}
    >
      {({ form, formState }) => (
        <form onSubmit={form.handleSubmit}>
          {/* 自定义表单内容 */}
        </form>
      )}
    </BaseForm>
  )
}
```

#### useForm()

表单 Hook，用于完全自定义表单实现。

```typescript
import { useForm } from '@airiot/client'

function CustomForm() {
  const { form, formState, values, errors } = useForm({
    schema: userSchema,
    onSubmit: handleSubmit
  })

  return (
    <form onSubmit={form.handleSubmit}>
      <input {...form.getInputProps('username')} />
      {errors.username && <span>{errors.username}</span>}
      <button type="submit">提交</button>
    </form>
  )
}
```

#### FieldArray

动态字段数组组件。

```typescript
import { SchemaForm, FieldArray } from '@airiot/client'

function DynamicForm() {
  return (
    <SchemaForm
      schema={schema}
      onSubmit={handleSubmit}
    >
      {(form) => (
        <FieldArray name="items">
          {({ fields }) => (
            <div>
              {fields.map((field, index) => (
                <div key={field.key}>
                  <input name={`items.${index}.name`} />
                  <button onClick={() => fields.remove(index)}>删除</button>
                </div>
              ))}
              <button onClick={() => fields.push({})}>添加</button>
            </div>
          )}
        </FieldArray>
      )}
    </SchemaForm>
  )
}
```

### JSON Schema 格式

#### 基础字段类型

```typescript
const schema = {
  type: 'object',
  properties: {
    // 文本字段
    username: {
      type: 'string',
      title: '用户名'
    },

    // 数字字段
    age: {
      type: 'number',
      title: '年龄'
    },

    // 整数字段
    count: {
      type: 'integer',
      title: '数量'
    },

    // 布尔字段
    isActive: {
      type: 'boolean',
      title: '是否激活'
    },

    // 日期字段
    birthDate: {
      type: 'string',
      format: 'date',
      title: '出生日期'
    },

    // 日期时间字段
    createdAt: {
      type: 'string',
      format: 'datetime',
      title: '创建时间'
    },

    // 时间字段
    time: {
      type: 'string',
      format: 'time',
      title: '时间'
    }
  }
}
```

#### 枚举字段

```typescript
const schema = {
  type: 'object',
  properties: {
    status: {
      type: 'string',
      title: '状态',
      enum: ['active', 'inactive', 'pending'],
      enumNames: ['激活', '未激活', '待定']
    },
    priority: {
      type: 'number',
      title: '优先级',
      enum: [1, 2, 3],
      enum_title: { 1: '高', 2: '中', 3: '低' }
    }
  }
}
```

#### 对象字段

```typescript
const schema = {
  type: 'object',
  properties: {
    address: {
      type: 'object',
      title: '地址',
      properties: {
        street: { type: 'string', title: '街道' },
        city: { type: 'string', title: '城市' },
        zipCode: { type: 'string', title: '邮编' }
      },
      required: ['city']
    }
  }
}
```

#### 数组字段

```typescript
const schema = {
  type: 'object',
  properties: {
    tags: {
      type: 'array',
      title: '标签',
      items: {
        type: 'string'
      }
    },
    items: {
      type: 'array',
      title: '项目',
      items: {
        type: 'object',
        properties: {
          name: { type: 'string', title: '名称' },
          price: { type: 'number', title: '价格' }
        }
      }
    }
  }
}
```

### 验证

#### 内置验证规则

```typescript
const schema = {
  type: 'object',
  properties: {
    username: {
      type: 'string',
      title: '用户名',
      minLength: 3,
      maxLength: 20,
      validationMessage: {
        minLength: '用户名至少 3 个字符',
        maxLength: '用户名最多 20 个字符'
      }
    },
    age: {
      type: 'integer',
      title: '年龄',
      minimum: 0,
      maximum: 120,
      exclusiveMinimum: false,
      exclusiveMaximum: false
    },
    email: {
      type: 'string',
      format: 'email',
      title: '邮箱'
    }
  },
  required: ['username', 'age']
}
```

#### 自定义验证函数

```typescript
import { SchemaForm } from '@airiot/client'

function MyForm() {
  const validate = (values) => {
    const errors = {}

    // 密码确认验证
    if (values.password !== values.confirmPassword) {
      errors.confirmPassword = '两次密码输入不一致'
    }

    // 自定义业务验证
    if (values.username === 'admin') {
      errors.username = '不能使用 admin 作为用户名'
    }

    return errors
  }

  return (
    <SchemaForm
      schema={schema}
      onSubmit={handleSubmit}
      validate={validate}
    />
  )
}
```

### 工具函数

#### `schemaConvert(schema, options)`

将 JSON Schema 转换为表单字段配置。

```typescript
import { schemaConvert } from '@airiot/client'

const formFields = schemaConvert(schema, {
  readonly: ['id'],
  required: ['username']
})
```

#### `fieldBuilder(key, schema, options)`

构建单个表单字段。

```typescript
import { fieldBuilder } from '@airiot/client'

const field = fieldBuilder('username', {
  type: 'string',
  title: '用户名'
}, {})
```

#### `objectBuilder(schema, options)`

构建对象表单字段。

```typescript
import { objectBuilder } from '@airiot/client'

const objectField = objectBuilder({
  type: 'object',
  properties: {
    username: { type: 'string', title: '用户名' }
  }
}, {})
```

### 高级功能

#### 自定义字段渲染器

```typescript
import { setFormFields } from '@airiot/client'

// 注册自定义字段渲染器
setFormFields({
  custom: ({ field, form }) => (
    <CustomComponent {...field} />
  )
})

// 在 schema 中使用
const schema = {
  type: 'object',
  properties: {
    customField: {
      type: 'string',
      title: '自定义字段',
      formRender: 'custom'
    }
  }
}
```

#### 自定义 Schema 转换器

```typescript
import { setSchemaConverters } from '@airiot/client'

// 注册自定义转换器
setSchemaConverters([
  (field, schema, options) => {
    if (schema.type === 'custom-type') {
      field.type = 'custom-component'
    }
    return field
  }
])
```

---

## 模型模块

模型模块提供完整的数据模型管理和状态管理功能，基于 Jotai 实现响应式状态。

### Model Registry

模型注册中心提供系统内置的 Airiot 模型，并支持动态注册自定义模型。

#### 内置模型

库内置了 46 个 Airiot 系统模型：

| 模型名称 | 中文名称 | API 资源路径 |
|---------|---------|-------------|
| Table | 数据表 | `core/t/schema` |
| Device | 单设备 | `core/t/schema` |
| systemvariable | 数据字典 | `core/systemVariable` |
| DriverInstance | 驱动管理 | `driver/driverInstance` |
| ProtocolProxy | 代理管理 | `driver/protocolProxy` |
| Instruct | 指令状态管理 | `driver/instruct` |
| DeviceArchive | 归档信息 | `driver/archivedlog` |
| NetworkGraph | 网络通信异常统计 | `core/t/record` |
| TaskManager | 后台任务管理 | `core/taskmanager` |
| DeviceEvent | 驱动事件信息 | `driver/event` |
| ArchiveEvent | 驱动事件归档信息 | `driver/archiveEvent` |
| System | 系统设置 | `setting` |
| backup | 备份与还原 | `core/backup` |
| dbBackup | 数据库备份 | `db-backup` |
| dbBackupFTP | 数据库备份 FTP | - |
| tsdbBackup | 历史数据备份 | `tsdb-backup` |
| tsdbBackupFTP | 历史数据备份 FTP | - |
| backupcycle | 周期备份 | `core/backupCycle` |
| Flow | 流程 | `flow/flow` |
| FlowTask | 我的任务 | `flow/flowTask/currentUser` |
| AllFlowTask | 任务管理 | `flow/flowTask` |
| FlowJob | 我发起的流程 | `engine/job` |
| JobInstance | 流程实例 | `engine/jobInstance` |
| ArchivedInstance | 流程实例归档 | `engine/archivedInstance` |
| Theme | 系统主题 | `core/theme` |
| Log | 操作日志 | `core/log` |
| Archivedlog | 日志归档信息 | `core/archivedlog` |
| Apipermission | 越权访问日志 | `core/apipermission` |
| SystemLog | 系统日志 | `syslog/log` |
| Dashboard | 画面 | `core/dashboard` |
| Site | 前台 | `core/site` |
| Warning | 告警管理 | - |
| Rule | 规则管理 | - |
| WarningArchive | 告警归档 | - |
| tRecord | 时序记录 | - |
| Report | 报表管理 | - |
| reportcopy | 报表复制 | - |
| algorithm | 算法管理 | - |
| OauthApp | OAuth 应用 | - |
| app | 应用管理 | - |
| Role | 角色管理 | - |
| User | 用户管理 | - |
| Licenseinfo | 许可证信息 | - |
| SafeZone | 安全区管理 | - |
| ExamineUser | 用户审批 | - |
| ExamineRole | 角色审批 | - |
| Datasource | 数据源管理 | - |
| Operation | 运算管理 | - |
| Service | 服务管理 | - |
| Dataset | 数据集管理 | - |
| DataView | 数据视图管理 | - |
| sync | 数据同步 | - |
| Media | 媒体管理 | - |
| Message | 消息管理 | - |
| Plan | 计划管理 | - |
| Review | 审查管理 | - |
| Playback | 回放管理 | - |
| warningPlayback | 告警回放 | - |
| warningCapture | 告警抓拍 | - |

#### 使用内置模型

```typescript
import { Model } from '@airiot/client'

function DeviceList() {
  return (
    <Model name="Device">
      <DeviceTable />
    </Model>
  )
}
```

#### 注册自定义模型

```typescript
import { modelRegistry } from '@airiot/client/model'

modelRegistry.registerModel('MyCustomModel', {
  name: 'myCustomModel',
  resource: 'api/custom',
  title: '我的自定义模型',
  properties: {
    id: { type: 'string', title: 'ID' },
    name: { type: 'string', title: '名称' }
  },
  listFields: ['id', 'name'],
  permission: { view: true, add: true, edit: true, delete: true }
})
```

#### ModelRegistry API

| 方法 | 说明 |
|-----|------|
| `getModels()` | 获取所有已注册的模型 |
| `getModel(name)` | 根据名称获取特定模型 |
| `registerModel(name, model)` | 注册新模型 |
| `getModelAtoms()` | 获取模型原子生成器 |
| `addModelAtoms(getAtoms)` | 添加模型原子生成器 |

### Model 组件

```typescript
import { Model } from '@airiot/client'

const userModel = {
  name: 'user',
  title: '用户',
  resource: 'core/user',
  properties: {
    username: { type: 'string', title: '用户名' },
    email: { type: 'string', title: '邮箱' }
  },
  listFields: ['username', 'email']
}

function UserManagement() {
  return (
    <Model model={userModel}>
      <UserList />
    </Model>
  )
}
```

**Props：**
- `name` - 模型名称（使用内置模型时）
- `schema` - 模型配置对象（自定义模型时）
- `modelKey` - 模型键名
- `initialValues` - 初始值
- `atoms` - 自定义原子
- `forceNewAtoms` - 是否强制创建新原子

### ModelHooks

#### `useModel()`

获取模型上下文。

```typescript
import { useModel } from '@airiot/client'

function MyComponent() {
  const { model, api, atoms } = useModel()

  return <div>{model.title}</div>
}
```

#### `useModelGet({ id, query, item })`

获取模型数据。

```typescript
import { useModelGet } from '@airiot/client'

function UserEdit({ userId }) {
  const { data, loading } = useModelGet({ id: userId })

  if (loading) return <Spinner />
  return <UserForm initialValues={data} />
}
```

#### `useModelSave()`

保存模型数据。

```typescript
import { useModelSave } from '@airiot/client'

function UserForm({ initialValues }) {
  const { saveItem } = useModelSave()

  const handleSubmit = async (values) => {
    try {
      await saveItem(values)
      message.success('保存成功')
    } catch (error) {
      message.error('保存失败')
    }
  }

  return <Form onSubmit={handleSubmit} initialValues={initialValues} />
}
```

#### `useModelDelete(props?)`

删除模型数据。

```typescript
import { useModelDelete } from '@airiot/client'

function UserItem({ userId }) {
  const { deleteItem } = useModelDelete()

  const handleDelete = async () => {
    await deleteItem(userId)
  }

  return <button onClick={handleDelete}>删除</button>
}
```

#### `useModelGetItems()`

获取数据列表。

```typescript
import { useModelGetItems } from '@airiot/client'

function UserList() {
  const { getItems } = useModelGetItems()

  const handleLoad = async () => {
    const { items, total } = await getItems({ limit: 10 })
  }

  return <button onClick={handleLoad}>加载</button>
}
```

#### `useModelList()`

获取列表数据（带自动刷新）。

```typescript
import { useModelList } from '@airiot/client'

function UserTable() {
  const { loading, items, fields, selected } = useModelList()

  return (
    <div>
      {loading ? <Spinner /> : <Table data={items} columns={fields} />}
    </div>
  )
}
```

#### `useModelPagination()`

分页功能。

```typescript
import { useModelPagination } from '@airiot/client'

function Pagination() {
  const { items, activePage, changePage } = useModelPagination()

  return (
    <PaginationComponent
      total={items}
      current={activePage}
      onChange={changePage}
    />
  )
}
```

#### `useModelPageSize()`

页面大小控制。

```typescript
import { useModelPageSize } from '@airiot/client'

function PageSizeControl() {
  const { sizes, setPageSize, size } = useModelPageSize()

  return (
    <Select value={size} onChange={setPageSize}>
      {sizes.map(s => <option key={s} value={s}>{s}</option>)}
    </Select>
  )
}
```

#### `useModelSelect()`

选择功能。

```typescript
import { useModelSelect } from '@airiot/client'

function SelectionTable() {
  const { count, selected, onSelect, onSelectAll } = useModelSelect()

  return (
    <Table
      data={items}
      selected={selected}
      onSelect={onSelect}
      onSelectAll={onSelectAll}
    />
  )
}
```

#### `useModelQuery()`

自定义查询。

```typescript
import { useModelQuery } from '@airiot/client'

function CustomQuery() {
  const { items, loading, model } = useModelQuery()

  if (loading) return <Spinner />
  return <CustomList data={items} />
}
```

#### `useModelPermission()`

权限检查。

```typescript
import { useModelPermission } from '@airiot/client'

function UserActions() {
  const { canAdd, canEdit, canDelete } = useModelPermission()

  return (
    <div>
      {canAdd && <Button>新增</Button>}
      {canEdit && <Button>编辑</Button>}
      {canDelete && <Button>删除</Button>}
    </div>
  )
}
```

#### `useModelEvent()`

事件处理。

```typescript
import { useModelEvent } from '@airiot/client'

function EventExample() {
  const { onLoad, onSave, onDelete } = useModelEvent()

  useEffect(() => {
    if (onLoad) onLoad()
  }, [])

  const handleSave = async (data) => {
    if (onSave) await onSave(data)
  }

  return <Form onSubmit={handleSave} />
}
```

#### `useModelFields()`

字段控制。

```typescript
import { useModelFields } from '@airiot/client'

function FieldControl() {
  const { fields, changeFieldDisplay, selected } = useModelFields()

  return (
    <div>
      {Object.entries(fields).map(([key, field]) => (
        <label key={key}>
          <input
            type="checkbox"
            checked={selected.includes(key)}
            onChange={(e) => changeFieldDisplay([key, e.target.checked])}
          />
          {field.title}
        </label>
      ))}
    </div>
  )
}
```

#### `useModelCount()`

获取总数。

```typescript
import { useModelCount } from '@airiot/client'

function CountDisplay() {
  const { count } = useModelCount()

  return <div>共 {count} 条数据</div>
}
```

### ModelAtoms 类型

```typescript
interface ModelAtoms {
  ids: WritableAtom<string[], any, void>
  item: (id: string) => WritableAtom<any, any, void>
  items: WritableAtom<any[], any, void>
  count: WritableAtom<number, any, void>
  selected: WritableAtom<any[], any, void>
  option: WritableAtom<any, any, void>
  optionSelector: (key: string) => WritableAtom<any, any, void>
  fields: WritableAtom<any, any, void>
  order: WritableAtom<any, any, void>
  limit: WritableAtom<number, any, void>
  skip: WritableAtom<number, any, void>
  wheres: WritableAtom<any, any, void>
  where: (id: string) => WritableAtom<any, any, void>
  loading: (key: string) => WritableAtom<boolean, any, void>
  itemSelected: (id: string) => WritableAtom<boolean, any, void>
  allSelected: WritableAtom<boolean, any, void>
  itemOrder: (field: string) => WritableAtom<string, any, void>
}
```

### ModelSchema 类型

```typescript
interface ModelSchema {
  name: string                              // 模型名称
  key?: string                               // 模型键名
  title: string                             // 显示标题
  icon?: string | ReactElement               // 图标
  permission?: {                            // CRUD 权限
    view?: boolean
    add?: boolean
    edit?: boolean
    delete?: boolean
  }
  initialValues?: any | (() => any)        // 初始查询值
  listFields?: string[]                     // 列表显示字段
  defaultOrder?: any                        // 默认排序
  orders?: any                             // 排序规则
  defaultPageSize?: number                   // 默认每页数量
  properties?: Record<string, Property>       // 字段定义（JSON Schema）
  displayField?: string                      // 显示字段
  components?: Record<string, React.ComponentType<any>> // 自定义组件
  atoms?: ModelAtoms                        // 状态原子
  blocks?: Record<string, Function>          // 块函数
  events?: Record<string, Function>          // 事件处理器
  itemActions?: string[]                    // 项目操作
  fieldRender?: Record<string, any>         // 字段渲染器
  editableFields?: string[]                 // 可编辑字段
  partialSave?: boolean                     // 是否允许部分保存
  forceGetItem?: boolean                   // 是否强制获取单项
  initQuery?: boolean                       // 是否初始化查询
  rolePermission?: Array<{key: string, title: string}> // 角色权限
  filters?: any                            // 筛选配置
  form?: any[]                             // 表单字段配置
  formProps?: any                          // 表单属性
  required?: string[]                       // 必填字段
  projectFields?: string[]                  // 投影字段
  [key: string]: any
}
```

---

## 工具函数

### getSettings()

获取服务器端设置（异步）。

```typescript
import { getSettings } from '@airiot/client'

async function loadSettings() {
  const settings = await getSettings()
  console.log('Settings:', settings)
}
```

**返回值：** 返回从 `core/setting` API 获取的设置对象。

### useMessage()

消息提示（需自行实现）。

```typescript
import { useMessage } from '@airiot/client'

function MyComponent() {
  const message = useMessage()

  const handleClick = () => {
    message.info('这是一条信息')
    message.success('操作成功')
    message.error('操作失败')
  }

  return <button onClick={handleClick}>显示消息</button>
}
```

**注意：** 默认实现是空函数，需要在应用中自行集成消息提示组件。

---

## 类型定义

### 主要类型导出

```typescript
// 模型类型
export type { ModelSchema, ModelAtoms, ModelContextType }

// 表单类型
export type { FormField, ConvertOptions }
```

---

## 常见使用模式

### 用户管理系统

#### 用户列表页面

```typescript
import { Model, useModelList, useModelPermission, useModelPagination, useModelPageSize, useModelSelect, useModelDelete } from '@airiot/client'

const userModel = {
  name: 'user',
  title: '用户',
  resource: 'core/user',
  properties: {
    username: { type: 'string', title: '用户名' },
    email: { type: 'string', title: '邮箱' },
    role: { type: 'string', title: '角色' }
  },
  listFields: ['username', 'email', 'role']
}

function UserList() {
  const { loading, items, selected } = useModelList()
  const { canAdd, canDelete } = useModelPermission()
  const { count, activePage, changePage } = useModelPagination()
  const { onSelect, onSelectAll } = useModelSelect()
  const { deleteItem } = useModelDelete()

  if (loading) return <Spinner />

  return (
    <div>
      {canAdd && <Button onClick={() => navigate('/users/new')}>新增</Button>}
      <Table data={items} selected={selected} onSelect={onSelect} />
      <Pagination total={count} current={activePage} onChange={changePage} />
    </div>
  )
}

export default function UserManagement() {
  return <Model model={userModel}><UserList /></Model>
}
```

#### 用户表单

```typescript
import { Model, useModelGet, useModelSave } from '@airiot/client'
import { SchemaForm } from '@airiot/client'

function UserForm() {
  const { data, loading } = useModelGet()
  const { saveItem } = useModelSave()

  const handleSubmit = async (values) => {
    try {
      await saveItem(values)
      message.success('保存成功')
      navigate('/users')
    } catch (error) {
      message.error('保存失败')
    }
  }

  if (loading) return <Spinner />

  return (
    <SchemaForm
      schema={userFormSchema}
      initialValues={data}
      onSubmit={handleSubmit}
    />
  )
}

export default function UserFormPage() {
  return <Model model={userModel}><UserForm /></Model>
}
```

### 受保护的路由

```typescript
import { useUser } from '@airiot/client'
import { Navigate } from 'react-router-dom'

function ProtectedRoute({ children, requiredPermissions = [] }) {
  const { user } = useUser()

  if (!user) {
    return <Navigate to="/login" replace />
  }

  if (requiredPermissions.length > 0) {
    const hasPermission = requiredPermissions.every(perm =>
      user.permissions?.includes(perm)
    )
    if (!hasPermission) {
      return <Navigate to="/403" replace />
    }
  }

  return children
}

// 使用示例
function App() {
  return (
    <Routes>
      <Route path="/login" element={<LoginPage />} />
      <Route
        path="/dashboard"
        element={<ProtectedRoute><Dashboard /></ProtectedRoute>}
      />
      <Route
        path="/admin"
        element={<ProtectedRoute requiredPermissions={['admin']}><AdminPanel /></ProtectedRoute>}
      />
    </Routes>
  )
}
```

### 数据筛选

```typescript
import { Model, useModelList, useModel } from '@airiot/client'
import { useSetAtom } from 'jotai'

function FilterPanel() {
  const { atoms } = useModel()
  const setWheres = useSetAtom(atoms.wheres)
  const setOption = useSetAtom(atoms.option)

  const handleFilter = (filters) => {
    const whereConditions = {}

    // 文本搜索
    if (filters.search) {
      whereConditions.username = { $regex: filters.search }
    }

    // 状态筛选
    if (filters.status) {
      whereConditions.status = { $eq: filters.status }
    }

    // 日期范围
    if (filters.dateRange) {
      whereConditions.createdAt = {
        $gte: filters.dateRange[0],
        $lte: filters.dateRange[1]
      }
    }

    setWheres(whereConditions)
    setOption({ skip: 0 })
  }

  return <FilterForm onFilter={handleFilter} />
}

function FilteredList() {
  const { items, loading } = useModelList()

  return (
    <div>
      <FilterPanel />
      {loading ? <Spinner /> : <Table data={items} />}
    </div>
  )
}
```

---

## 最佳实践

### 1. 初始化配置

在应用入口统一配置全局设置：

```typescript
// main.tsx
import { setConfig } from '@airiot/client'

setConfig({
  language: 'zh-CN',
  module: 'admin',
  settings: {
    safeRequest: true
  }
})
```

### 2. 使用内置模型

优先使用内置模型而不是自定义模型：

```typescript
// 推荐：使用内置模型
<Model name="User">
  <UserList />
</Model>

// 不推荐：重复定义
<Model model={userModel}>
  <UserList />
</Model>
```

### 3. 错误处理

统一处理 API 错误：

```typescript
const handleApiError = (error) => {
  const message = useMessage()

  if (error.status === 401) {
    navigate('/login')
  } else if (error.status === 403) {
    message.error('无权限')
  } else if (error.status === 500) {
    message.error('服务器错误')
  } else {
    message.error(error.json?._error || '操作失败')
  }
}
```

### 4. 状态管理

使用模型原子的 Hook 而不是直接访问：

```typescript
// 推荐
const { atoms } = useModel()
const setWheres = useSetAtom(atoms.wheres)

// 不推荐
const [wheres, setWheres] = useState({})
```

### 5. 表单验证

使用 JSON Schema 进行声明式验证：

```typescript
const schema = {
  type: 'object',
  properties: {
    username: {
      type: 'string',
      minLength: 3,
      maxLength: 20
    }
  },
  required: ['username']
}
```

### 6. 性能优化

使用 `useMemo` 和 `useCallback` 优化组件性能：

```typescript
function MyComponent() {
  const { items } = useModelList()

  const filteredItems = useMemo(() => {
    return items.filter(item => item.active)
  }, [items])

  const handleClick = useCallback(() => {
    // 处理逻辑
  }, [])

  return <div>{/* ... */}</div>
}
```

### 7. 类型安全

充分利用 TypeScript 类型定义：

```typescript
import type { ModelSchema } from '@airiot/client'

const myModel: ModelSchema = {
  name: 'myModel',
  title: 'My Model',
  // ...
}
```

---

## 快速参考

### 导入路径

```typescript
// API 模块
import { createAPI, setContext, getContext } from '@airiot/client'

// 认证模块
import { useLogin, useLogout, useUser, useUserReg } from '@airiot/client'

// 表单模块
import { Form, SchemaForm, useForm, FieldArray } from '@airiot/client'
import { fieldBuilder, objectBuilder, schemaConvert } from '@airiot/client'

// 模型模块
import { Model, ModelContext, modelRegistry } from '@airiot/client'
import {
  useModel, useModelValue, useModelState, useSetModelState,
  useModelGet, useModelSave, useModelDelete,
  useModelGetItems, useModelItem, useModelQuery,
  useModelPermission, useModelEvent, useModelEffect,
  useModelPagination, useModelCount, useModelPageSize,
  useModelFields, useModelList, useModelSelect,
  useModelListRow, useModelListHeader, useModelListOrder, useModelListItem
} from '@airiot/client'

// 工具函数
import { getConfig, setConfig } from '@airiot/client'
import { getSettings, useMessage } from '@airiot/client'

// 类型定义
import type { ModelSchema, ModelAtoms } from '@airiot/client'
import type { FormField, ConvertOptions } from '@airiot/client'
```

### Peer Dependencies

```bash
npm install react react-dom react-router
npm install jotai dayjs axios lodash
npm install final-form ajv react-final-form react-final-form-arrays
npm install crypto-js localforage
```

---

## 故障排除

### 常见问题

#### 1. 登录后跳转到错误页面

确保 `react-router` 的路由配置正确，检查 `location.state` 的使用。

#### 2. 表单验证不生效

检查 JSON Schema 格式是否正确，`required` 字段必须在对象级别定义。

#### 3. 模型数据不更新

确保 `useModelEffect()` Hook 正确使用，它会自动响应 `option` 和 `wheres` 的变化。

#### 4. API 请求失败

检查全局配置中的 `user.token` 是否正确设置，确认网络请求地址是否可达。

---

## 总结

@airiot/client 提供了一套完整的工具链，帮助你快速构建 React 应用：

1. **API 模块** - 简化的 HTTP 请求
2. **认证模块** - 完整的用户认证流程
3. **表单模块** - 基于 Schema 的表单构建
4. **模型模块** - 集成的状态管理
5. **内置模型** - 46 个预置的系统模型

遵循本指南的最佳实践，可以高效、安全地使用这个库的所有功能。
